// Generated by CoffeeScript 1.10.0
(function(window, $, templates) {
  var addDiskField, currentId, diskField, diskForm, diskFormContainer, errorMessage, handleButton, initPlugin, markDone, pollState, reloadForm, section, setIcon, stateUrl, submitData, updateForm, url;
  diskFormContainer = $('#dashboard-diskspace-panel');
  section = diskFormContainer.parents('.o-collapsible-section');
  errorMessage = templates.diskspaceConsolidateSubmitError;
  diskForm = null;
  diskField = null;
  url = null;
  stateUrl = null;
  currentId = null;
  addDiskField = function() {
    var field;
    field = $('<input type="hidden" name="storage_id">');
    (diskFormContainer.find('form')).append(field);
    return field;
  };
  updateForm = function(markup) {
    diskFormContainer.html(markup);
    diskForm = diskFormContainer.find('form');
    diskField = addDiskField();
    section.trigger('remax');
  };
  reloadForm = function() {
    var res;
    res = $.get(url);
    return res.done(updateForm);
  };
  setIcon = function(button, name) {
    (button.find('.icon')).remove();
    return button.prepend("<span class=\"icon icon-" + name + "\"></span>");
  };
  markDone = function(storageId) {
    var button;
    button = diskFormContainer.find('#' + storageId);
    setIcon(button, 'ok');
    button.addClass('diskspace-consolidation-started');
    return setTimeout(function() {
      return reloadForm();
    }, 6000);
  };
  pollState = function(storageId) {
    return setTimeout(function() {
      var res;
      res = $.get(stateUrl);
      return res.done(function(data) {
        if (data.active != null) {
          reloadForm();
          pollState(storageId);
          return;
        }
        markDone(storageId);
      });
    }, 2000);
  };
  submitData = function(e) {
    var diskId, res;
    e.preventDefault();
    res = $.post(url, diskForm.serialize());
    diskId = diskField.val();
    res.done(function(data) {
      updateForm(data);
      if ((diskFormContainer.find('.o-form-errors')).length) {
        return;
      }
      pollState(diskId);
    });
    res.fail(function() {
      diskFormContainer.prepend(errorMessage);
    });
  };
  handleButton = function(e) {
    var diskId, el;
    el = $(this);
    diskId = el.attr('value');
    diskField.val(diskId);
  };
  initPlugin = function(e) {
    diskForm = diskFormContainer.find('form');
    url = diskForm.attr('action');
    stateUrl = diskForm.data('state-url');
    currentId = diskForm.data('started');
    diskField = addDiskField();
    diskFormContainer.on('click', 'button', handleButton);
    diskFormContainer.on('submit', 'form', submitData);
    if (currentId) {
      return pollState(currentId);
    }
  };
  return section.on('dashboard-plugin-loaded', initPlugin);
})(this, this.jQuery, this.templates);
