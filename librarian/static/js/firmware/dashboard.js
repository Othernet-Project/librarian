// Generated by CoffeeScript 1.10.0
(function(window, $, templates) {
  var FAILED_STATUS, POLL_DELAY, TIMEOUT, container, form, iframe, initPlugin, messages, partialSelector, pollProgress, section, setMessage, statusUrl, updateProgress, uploadDone, uploadStart;
  partialSelector = "#firmware-update-container";
  container = $("#dashboard-firmware-panel");
  section = container.parents('.o-collapsible-section');
  messages = {
    'firmwareUploading': null,
    'firmwareUpdating': null,
    'firmwareUpdateFailed': null,
    'firmwareWaitForReboot': null
  };
  form = null;
  iframe = null;
  statusUrl = null;
  TIMEOUT = 45000;
  POLL_DELAY = 5000;
  FAILED_STATUS = 'failed';
  setMessage = function(msg) {
    container.find('.firmware-messages').remove();
    container.prepend(msg);
    return section.trigger('remax');
  };
  uploadStart = function(e) {
    var button;
    button = container.find('button');
    button.prop('disabled', true);
    setMessage(messages.firmwareUploading);
  };
  uploadDone = function(e) {
    var isSaved, partial;
    partial = iframe.contents().find(partialSelector);
    container.html(partial);
    section.trigger('remax');
    initPlugin();
    isSaved = form.data('saved');
    if (isSaved === true) {
      return updateProgress();
    }
  };
  updateProgress = function() {
    setMessage(messages.firmwareUpdating);
    return setTimeout(pollProgress, POLL_DELAY);
  };
  pollProgress = function() {
    var res;
    res = $.ajax({
      url: statusUrl,
      timeout: TIMEOUT
    });
    res.done(function(data) {
      if (data.status === FAILED_STATUS) {
        setMessage(messages.firmwareUpdateFailed);
        return;
      }
      return setTimeout(pollProgress, POLL_DELAY);
    });
    return res.fail(function() {
      setMessage(messages.firmwareWaitForReboot);
    });
  };
  initPlugin = function(e) {
    var msgId;
    for (msgId in messages) {
      if (messages[msgId] === null) {
        $("#" + msgId).loadTemplate();
        messages[msgId] = templates[msgId];
      }
    }
    form = container.find('form');
    form.on('submit', uploadStart);
    iframe = container.find('iframe');
    iframe.on('load', uploadDone);
    return statusUrl = form.data('status-url');
  };
  return section.on('dashboard-plugin-loaded', initPlugin);
})(this, this.jQuery, this.templates);
